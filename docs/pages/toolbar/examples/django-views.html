# views.py
from django.http import HttpResponse
from django.shortcuts import get_object_or_404, redirect
from django.views.decorators.http import require_POST, require_http_methods
from django.template.loader import render_to_string
from .models import Document, Item

@require_POST
def document_save(request, document_id):
    """Guarda el documento y devuelve feedback."""
    document = get_object_or_404(Document, id=document_id, user=request.user)

    # Procesar datos del formulario si es necesario
    document.content = request.POST.get('content', document.content)
    document.save()

    # Devolver mensaje de estado
    return HttpResponse(
        '<span class="ux-toolbar__text" style="color: var(--ux-success);">'
        'Guardado'
        '</span>'
    )

@require_http_methods(["DELETE"])
def document_delete(request, document_id):
    """Elimina el documento y redirige."""
    document = get_object_or_404(Document, id=document_id, user=request.user)
    document.delete()

    # Redirigir a la lista de documentos
    response = HttpResponse()
    response['HX-Redirect'] = '/documents/'
    return response

@require_POST
def item_share(request, item_id):
    """Genera enlace para compartir."""
    item = get_object_or_404(Item, id=item_id, user=request.user)
    share_url = item.get_share_url()

    return HttpResponse(
        f'<div class="ux-toast ux-toast--success">'
        f'Enlace copiado: {share_url}'
        f'</div>'
    )

@require_POST
def item_bookmark(request, item_id):
    """Toggle bookmark y devuelve boton actualizado."""
    item = get_object_or_404(Item, id=item_id, user=request.user)
    item.is_bookmarked = not item.is_bookmarked
    item.save()

    # Devolver el boton con estado actualizado
    return HttpResponse(render_to_string(
        'partials/bookmark_button.html',
        {'item': item}
    ))

@require_POST
def item_duplicate(request, item_id):
    """Duplica el item y devuelve el nuevo elemento."""
    item = get_object_or_404(Item, id=item_id, user=request.user)

    # Crear copia
    new_item = Item.objects.create(
        user=request.user,
        title=f"{item.title} (copia)",
        content=item.content
    )

    # Devolver el nuevo item renderizado
    return HttpResponse(render_to_string(
        'partials/item_row.html',
        {'item': new_item}
    ))
