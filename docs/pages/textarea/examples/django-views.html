# views.py
from django.http import HttpResponse
from django.views.decorators.http import require_POST
from django.contrib.auth.decorators import login_required
from .models import Article

@login_required
@require_POST
def save_draft(request, article_id):
    """Guarda el borrador del articulo automaticamente."""
    article = Article.objects.get(id=article_id, author=request.user)
    content = request.POST.get('content', '')

    article.content = content
    article.is_draft = True
    article.save(update_fields=['content', 'is_draft', 'updated_at'])

    return HttpResponse(status=204)  # No Content


@require_POST
def char_count(request):
    """Devuelve el conteo de caracteres para el textarea."""
    text = request.POST.get('description', '')
    count = len(text)
    max_length = 500

    # Clase CSS segun proximidad al limite
    css_class = ''
    if count >= max_length:
        css_class = 'ux-textarea__counter--error'
    elif count >= max_length * 0.9:
        css_class = 'ux-textarea__counter--warning'

    return HttpResponse(
        f'<span class="{css_class}">{count}/{max_length}</span>'
    )
