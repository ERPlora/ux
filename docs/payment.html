<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Payment - UX Library</title>
  <link rel="stylesheet" href="../bootstrap-grid.min.css">
  <script src="../dist/ux.min.js"></script>
  <script src="../components/ux-code-block.js"></script>

  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
      background: var(--ux-surface-secondary);
      padding: 2rem;
      padding-bottom: 4rem;
    }
    .demo-section {
      margin-bottom: 3rem;
    }
    .demo-section h2 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--ux-text);
    }
    .demo-section h3 {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0.75rem;
      color: var(--ux-text-secondary);
    }
    .demo-box {
      background: var(--ux-surface);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    .demo-box--dark {
      background: var(--ux-gray-900);
    }
    .demo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
    }
    code {
      background: var(--ux-surface-tertiary);
      padding: 0.125rem 0.375rem;
      border-radius: 4px;
      font-size: 0.875rem;
    }
    .event-log {
      font-family: monospace;
      font-size: 0.75rem;
      background: var(--ux-gray-900);
      color: var(--ux-green-400);
      padding: 0.75rem;
      border-radius: 8px;
      max-height: 150px;
      overflow-y: auto;
    }
    .demo-glass-bg {
      background: linear-gradient(135deg, var(--ux-blue-400), var(--ux-purple-500));
      padding: 2rem;
      border-radius: 16px;
    }
  </style>
</head>
<body class="ux-app">

  <h1 style="margin-bottom: 0.5rem;">Payment Selector</h1>
  <p style="color: var(--ux-text-secondary); margin-bottom: 2rem;">
    Componentes para selección de método de pago, cálculo de cambio y pagos divididos para POS.
  </p>

  <!-- Basic Payment Methods -->
  <section class="demo-section">
    <h2>Métodos de Pago Básicos</h2>
    <p style="color: var(--ux-text-secondary); margin-bottom: 1rem;">
      Selección simple de método de pago con iconos y estado seleccionado.
    </p>

    <div class="demo-box" x-data="uxPayment({
      total: 45.50,
      methods: [
        { id: 'cash', name: 'Efectivo', icon: 'cash' },
        { id: 'card', name: 'Tarjeta', icon: 'card' },
        { id: 'contactless', name: 'Contactless', icon: 'contactless' },
        { id: 'wallet', name: 'Digital', icon: 'wallet' }
      ]
    })" @payment:method-selected.window="console.log('Método:', $event.detail)">
      <div class="ux-payment">
        <div class="ux-payment__section">
          <span class="ux-payment__label">Método de pago</span>
          <div class="ux-payment-methods">
            <template x-for="method in methods" :key="method.id">
              <div class="ux-payment-method"
                   :class="{ 'ux-payment-method--selected': selectedMethod === method.id }"
                   @click="selectMethod(method.id)">
                <div class="ux-payment-method__icon" x-html="getIcon(method.icon)"></div>
                <span class="ux-payment-method__name" x-text="method.name"></span>
              </div>
            </template>
          </div>
        </div>

        <div class="ux-payment-summary">
          <div class="ux-payment-summary__row ux-payment-summary__row--total">
            <span class="ux-payment-summary__label">Total a pagar</span>
            <span class="ux-payment-summary__value" x-text="formatCurrency(total)"></span>
          </div>
        </div>

        <button class="ux-button ux-color-primary" style="width: 100%;"
                @click="processPayment()" :disabled="!selectedMethod">
          Pagar con <span x-text="methods.find(m => m.id === selectedMethod)?.name || '...'"></span>
        </button>
      </div>
    </div>

    <pre class="ux-code-block" data-lang="html">&lt;div x-data="uxPayment({
  total: 45.50,
  methods: [
    { id: 'cash', name: 'Efectivo', icon: 'cash' },
    { id: 'card', name: 'Tarjeta', icon: 'card' },
    { id: 'contactless', name: 'Contactless', icon: 'contactless' }
  ]
})"&gt;
  &lt;div class="ux-payment-methods"&gt;
    &lt;template x-for="method in methods"&gt;
      &lt;div class="ux-payment-method"
           :class="{ 'ux-payment-method--selected': selectedMethod === method.id }"
           @click="selectMethod(method.id)"&gt;
        &lt;div class="ux-payment-method__icon" x-html="getIcon(method.icon)"&gt;&lt;/div&gt;
        &lt;span class="ux-payment-method__name" x-text="method.name"&gt;&lt;/span&gt;
      &lt;/div&gt;
    &lt;/template&gt;
  &lt;/div&gt;
&lt;/div&gt;</pre>
  </section>

  <!-- Payment with Change Calculator -->
  <section class="demo-section">
    <h2>Calculadora de Cambio</h2>
    <p style="color: var(--ux-text-secondary); margin-bottom: 1rem;">
      Calcula el cambio automáticamente. Incluye montos rápidos y opción de importe exacto.
    </p>

    <div class="demo-box" x-data="uxPayment({
      total: 27.80,
      quickAmounts: [10, 20, 30, 50, 100],
      methods: [
        { id: 'cash', name: 'Efectivo', icon: 'cash' }
      ],
      defaultMethod: 'cash'
    })">
      <div class="ux-payment">
        <div class="ux-payment__section">
          <span class="ux-payment__label">Importe recibido</span>
          <div class="ux-payment-quick">
            <template x-for="amount in quickAmounts" :key="amount">
              <button class="ux-payment-quick__btn"
                      :class="{ 'ux-payment-quick__btn--exact': amount === total }"
                      @click="addQuickAmount(amount)"
                      x-text="formatCurrency(amount)">
              </button>
            </template>
            <button class="ux-payment-quick__btn ux-payment-quick__btn--exact"
                    @click="setExactAmount()">
              Exacto
            </button>
          </div>
        </div>

        <div class="ux-payment-change">
          <div class="ux-payment-change__row">
            <span class="ux-payment-change__label">Total a cobrar</span>
            <span class="ux-payment-change__value" x-text="formatCurrency(total)"></span>
          </div>
          <div class="ux-payment-change__row">
            <span class="ux-payment-change__label">Recibido</span>
            <span class="ux-payment-change__value" x-text="formatCurrency(amountReceived)"></span>
          </div>
          <div class="ux-payment-change__row ux-payment-change__row--total"
               :class="{ 'ux-payment-change__row--change': change > 0, 'ux-payment-change__row--due': amountDue > 0 && amountReceived > 0 }">
            <span class="ux-payment-change__label" x-text="change > 0 ? 'Cambio' : 'Pendiente'"></span>
            <span class="ux-payment-change__value" x-text="formatCurrency(change > 0 ? change : amountDue)"></span>
          </div>
        </div>

        <button class="ux-button ux-color-success" style="width: 100%;"
                :disabled="!isPaid"
                @click="processPayment()">
          <span x-show="isPaid">Completar Venta</span>
          <span x-show="!isPaid">Faltan <span x-text="formatCurrency(amountDue)"></span></span>
        </button>
      </div>
    </div>
  </section>

  <!-- Split Payment -->
  <section class="demo-section">
    <h2>Pago Dividido</h2>
    <p style="color: var(--ux-text-secondary); margin-bottom: 1rem;">
      Permite dividir el pago entre múltiples métodos.
    </p>

    <div class="demo-box" x-data="uxPayment({
      total: 156.00,
      allowSplit: true,
      methods: [
        { id: 'cash', name: 'Efectivo', icon: 'cash' },
        { id: 'card', name: 'Tarjeta', icon: 'card' },
        { id: 'voucher', name: 'Vale', icon: 'voucher' }
      ]
    })" x-init="addSplitPayment('cash', 100)">
      <div class="ux-payment">
        <div class="ux-payment__section">
          <span class="ux-payment__label">Pagos realizados</span>
          <div class="ux-payment-split">
            <template x-for="payment in splitPayments" :key="payment.id">
              <div class="ux-payment-split__item">
                <div class="ux-payment-split__method">
                  <div class="ux-payment-split__method-icon" x-html="getIcon(payment.method.icon)"></div>
                  <span class="ux-payment-split__method-name" x-text="payment.method.name"></span>
                </div>
                <span class="ux-payment-split__amount" x-text="formatCurrency(payment.amount)"></span>
                <button class="ux-payment-split__remove" @click="removeSplitPayment(payment.id)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                  </svg>
                </button>
              </div>
            </template>

            <template x-if="amountDue > 0">
              <div class="ux-payment-split__add" @click="$refs.splitModal.showModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 5v14M5 12h14"/>
                </svg>
                Añadir pago (<span x-text="formatCurrency(amountDue)"></span> pendiente)
              </div>
            </template>
          </div>
        </div>

        <div class="ux-payment-summary">
          <div class="ux-payment-summary__row">
            <span class="ux-payment-summary__label">Total</span>
            <span class="ux-payment-summary__value" x-text="formatCurrency(total)"></span>
          </div>
          <div class="ux-payment-summary__row">
            <span class="ux-payment-summary__label">Pagado</span>
            <span class="ux-payment-summary__value" x-text="formatCurrency(totalPaid)"></span>
          </div>
          <div class="ux-payment-summary__row" x-show="amountDue > 0">
            <span class="ux-payment-summary__label">Pendiente</span>
            <span class="ux-payment-summary__value" style="color: var(--ux-danger);" x-text="formatCurrency(amountDue)"></span>
          </div>
          <div class="ux-payment-summary__row" x-show="change > 0">
            <span class="ux-payment-summary__label">Cambio</span>
            <span class="ux-payment-summary__value" style="color: var(--ux-success);" x-text="formatCurrency(change)"></span>
          </div>
        </div>

        <button class="ux-button ux-color-success" style="width: 100%;"
                :disabled="!isPaid"
                @click="processPayment()">
          Completar Venta
        </button>

        <!-- Split payment modal -->
        <dialog x-ref="splitModal" class="ux-modal" style="max-width: 320px;">
          <div class="ux-modal__header">
            <h3 class="ux-modal__title">Añadir pago</h3>
            <button class="ux-modal__close" @click="$refs.splitModal.close()">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <div class="ux-modal__content">
            <div class="ux-payment-methods ux-payment-methods--list" style="margin-bottom: 1rem;">
              <template x-for="method in methods" :key="method.id">
                <div class="ux-payment-method ux-payment-method--horizontal"
                     @click="addSplitPayment(method.id, amountDue); $refs.splitModal.close()">
                  <div class="ux-payment-method__icon" style="width: 24px; height: 24px;" x-html="getIcon(method.icon)"></div>
                  <span class="ux-payment-method__name" x-text="method.name"></span>
                </div>
              </template>
            </div>
          </div>
        </dialog>
      </div>
    </div>
  </section>

  <!-- Horizontal Methods -->
  <section class="demo-section">
    <h2>Métodos en Lista</h2>
    <p style="color: var(--ux-text-secondary); margin-bottom: 1rem;">
      Variante horizontal para espacios reducidos.
    </p>

    <div class="demo-box" style="max-width: 400px;" x-data="uxPayment({
      total: 89.99,
      methods: [
        { id: 'cash', name: 'Efectivo', icon: 'cash', desc: 'Pago en efectivo' },
        { id: 'card', name: 'Tarjeta de crédito', icon: 'card', desc: 'Visa, Mastercard, Amex' },
        { id: 'transfer', name: 'Transferencia', icon: 'transfer', desc: 'SEPA, Bizum' },
        { id: 'qr', name: 'Código QR', icon: 'qr', desc: 'Escanear para pagar' }
      ]
    })">
      <div class="ux-payment">
        <div class="ux-payment__section">
          <span class="ux-payment__label">Selecciona método de pago</span>
          <div class="ux-payment-methods ux-payment-methods--list">
            <template x-for="method in methods" :key="method.id">
              <div class="ux-payment-method ux-payment-method--horizontal"
                   :class="{ 'ux-payment-method--selected': selectedMethod === method.id }"
                   @click="selectMethod(method.id)">
                <div class="ux-payment-method__icon" x-html="getIcon(method.icon)"></div>
                <div style="flex: 1;">
                  <div class="ux-payment-method__name" x-text="method.name"></div>
                  <div class="ux-payment-method__desc" x-text="method.desc"></div>
                </div>
              </div>
            </template>
          </div>
        </div>

        <div style="display: flex; justify-content: space-between; padding: 1rem 0; border-top: 1px solid var(--ux-border-color);">
          <span style="color: var(--ux-text-secondary);">Total</span>
          <span style="font-size: 1.25rem; font-weight: 700;" x-text="formatCurrency(total)"></span>
        </div>
      </div>
    </div>
  </section>

  <!-- Glass Variant -->
  <section class="demo-section">
    <h2>Glass Variant</h2>
    <p style="color: var(--ux-text-secondary); margin-bottom: 1rem;">
      Estilo glass morphism para interfaces modernas.
    </p>

    <div class="demo-glass-bg">
      <div x-data="uxPayment({
        total: 125.00,
        quickAmounts: [50, 100, 150, 200],
        methods: [
          { id: 'cash', name: 'Efectivo', icon: 'cash' },
          { id: 'card', name: 'Tarjeta', icon: 'card' },
          { id: 'contactless', name: 'NFC', icon: 'contactless' }
        ]
      })">
        <div class="ux-payment ux-payment--glass">
          <div class="ux-payment__section">
            <span class="ux-payment__label" style="color: var(--ux-primary-contrast);">Método de pago</span>
            <div class="ux-payment-methods ux-payment-methods--3col">
              <template x-for="method in methods" :key="method.id">
                <div class="ux-payment-method"
                     :class="{ 'ux-payment-method--selected': selectedMethod === method.id }"
                     @click="selectMethod(method.id)">
                  <div class="ux-payment-method__icon" x-html="getIcon(method.icon)"></div>
                  <span class="ux-payment-method__name" x-text="method.name"></span>
                </div>
              </template>
            </div>
          </div>

          <div class="ux-payment__section" x-show="selectedMethod === 'cash'">
            <span class="ux-payment__label" style="color: var(--ux-primary-contrast);">Importe</span>
            <div class="ux-payment-quick">
              <template x-for="amount in quickAmounts" :key="amount">
                <button class="ux-payment-quick__btn" @click="addQuickAmount(amount)" x-text="formatCurrency(amount)"></button>
              </template>
            </div>
          </div>

          <div class="ux-payment-change" x-show="selectedMethod === 'cash' && amountReceived > 0">
            <div class="ux-payment-change__row">
              <span class="ux-payment-change__label">Total</span>
              <span class="ux-payment-change__value" x-text="formatCurrency(total)"></span>
            </div>
            <div class="ux-payment-change__row">
              <span class="ux-payment-change__label">Recibido</span>
              <span class="ux-payment-change__value" x-text="formatCurrency(amountReceived)"></span>
            </div>
            <div class="ux-payment-change__row ux-payment-change__row--total ux-payment-change__row--change" x-show="change > 0">
              <span class="ux-payment-change__label">Cambio</span>
              <span class="ux-payment-change__value" x-text="formatCurrency(change)"></span>
            </div>
          </div>

          <button class="ux-button ux-button--glass" style="width: 100%; color: var(--ux-primary-contrast); border-color: var(--ux-glass-bg-thin);">
            Procesar Pago
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Compact POS -->
  <section class="demo-section">
    <h2>POS Compacto</h2>
    <p style="color: var(--ux-text-secondary); margin-bottom: 1rem;">
      Versión compacta optimizada para terminales POS.
    </p>

    <div class="demo-grid">
      <div class="demo-box" x-data="uxPayment({
        total: 32.50,
        quickAmounts: [20, 35, 40, 50],
        methods: [
          { id: 'cash', name: 'Efectivo', icon: 'cash' },
          { id: 'card', name: 'Tarjeta', icon: 'card' }
        ],
        defaultMethod: 'cash'
      })">
        <div class="ux-payment ux-payment--compact">
          <div class="ux-payment-methods ux-payment-methods--2col" style="margin-bottom: 1rem;">
            <template x-for="method in methods" :key="method.id">
              <div class="ux-payment-method"
                   :class="{ 'ux-payment-method--selected': selectedMethod === method.id }"
                   @click="selectMethod(method.id)">
                <div class="ux-payment-method__icon" x-html="getIcon(method.icon)"></div>
                <span class="ux-payment-method__name" x-text="method.name"></span>
              </div>
            </template>
          </div>

          <div class="ux-payment-quick ux-payment-quick--5col" x-show="selectedMethod === 'cash'" style="margin-bottom: 1rem;">
            <template x-for="amount in quickAmounts" :key="amount">
              <button class="ux-payment-quick__btn" @click="addQuickAmount(amount)" x-text="amount + '€'"></button>
            </template>
            <button class="ux-payment-quick__btn ux-payment-quick__btn--exact" @click="setExactAmount()">OK</button>
          </div>

          <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--ux-surface-secondary); border-radius: 8px; margin-bottom: 0.75rem;">
            <div>
              <div style="font-size: 0.75rem; color: var(--ux-text-tertiary);">Total</div>
              <div style="font-size: 1.25rem; font-weight: 700;" x-text="formatCurrency(total)"></div>
            </div>
            <div x-show="selectedMethod === 'cash' && change > 0" style="text-align: right;">
              <div style="font-size: 0.75rem; color: var(--ux-text-tertiary);">Cambio</div>
              <div style="font-size: 1.25rem; font-weight: 700; color: var(--ux-success);" x-text="formatCurrency(change)"></div>
            </div>
          </div>

          <button class="ux-button ux-color-success ux-button--sm" style="width: 100%;"
                  :disabled="selectedMethod === 'cash' && !isPaid"
                  @click="processPayment()">
            Cobrar
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Events -->
  <section class="demo-section">
    <h2>Eventos</h2>
    <p style="color: var(--ux-text-secondary); margin-bottom: 1rem;">
      El componente emite eventos para integración con tu aplicación.
    </p>

    <div class="demo-box" x-data="{
      ...uxPayment({
        total: 50.00,
        quickAmounts: [20, 50, 100],
        methods: [
          { id: 'cash', name: 'Efectivo', icon: 'cash' },
          { id: 'card', name: 'Tarjeta', icon: 'card' }
        ]
      }),
      eventLog: []
    }"
    @payment:method-selected="eventLog.unshift('method-selected: ' + $event.detail.method)"
    @payment:amount-changed="eventLog.unshift('amount-changed: ' + $event.detail.amount + '€')"
    @payment:processed="eventLog.unshift('processed: ' + JSON.stringify($event.detail))"
    @payment:insufficient="eventLog.unshift('insufficient: faltan ' + $event.detail.due + '€')">
      <div class="row g-3">
        <div class="col-md-6">
          <div class="ux-payment">
            <div class="ux-payment-methods ux-payment-methods--2col" style="margin-bottom: 1rem;">
              <template x-for="method in methods" :key="method.id">
                <div class="ux-payment-method"
                     :class="{ 'ux-payment-method--selected': selectedMethod === method.id }"
                     @click="selectMethod(method.id)">
                  <div class="ux-payment-method__icon" x-html="getIcon(method.icon)"></div>
                  <span class="ux-payment-method__name" x-text="method.name"></span>
                </div>
              </template>
            </div>

            <div class="ux-payment-quick" style="margin-bottom: 1rem;">
              <template x-for="amount in quickAmounts" :key="amount">
                <button class="ux-payment-quick__btn" @click="addQuickAmount(amount)" x-text="formatCurrency(amount)"></button>
              </template>
            </div>

            <button class="ux-button ux-color-primary" style="width: 100%;" @click="processPayment()">
              Procesar Pago
            </button>
          </div>
        </div>
        <div class="col-md-6">
          <h4 style="font-size: 0.875rem; margin-bottom: 0.5rem;">Event Log:</h4>
          <div class="event-log">
            <template x-for="(event, i) in eventLog.slice(0, 10)" :key="i">
              <div x-text="event"></div>
            </template>
            <div x-show="eventLog.length === 0" style="color: var(--ux-gray-500);">
              Interactúa con el componente...
            </div>
          </div>
        </div>
      </div>
    </div>

    <h3>Eventos disponibles</h3>
    <pre class="ux-code-block" data-lang="javascript">@payment:method-selected  // Método seleccionado
@payment:amount-changed   // Importe cambiado
@payment:processed        // Pago procesado exitosamente
@payment:insufficient     // Importe insuficiente
@payment:split-added      // Pago dividido añadido
@payment:split-removed    // Pago dividido eliminado
@payment:reset            // Componente reiniciado</pre>
  </section>

  <!-- API Reference -->
  <section class="demo-section">
    <h2>API Reference</h2>

    <h3>Opciones</h3>
    <pre class="ux-code-block" data-lang="javascript">uxPayment({
  total: 100.00,              // Total a cobrar
  currency: '€',              // Símbolo de moneda
  currencyPosition: 'after',  // 'before' o 'after'
  quickAmounts: [5, 10, 20, 50, 100],
  methods: [
    { id: 'cash', name: 'Efectivo', icon: 'cash' },
    { id: 'card', name: 'Tarjeta', icon: 'card' }
  ],
  defaultMethod: 'cash',      // Método preseleccionado
  allowSplit: false,          // Permitir pago dividido
  showChange: true            // Mostrar calculadora de cambio
})</pre>

    <h3>Propiedades reactivas</h3>
    <pre class="ux-code-block" data-lang="javascript">selectedMethod   // ID del método seleccionado
amountReceived   // Importe recibido
splitPayments    // Array de pagos divididos
change           // Cambio a devolver (computed)
amountDue        // Importe pendiente (computed)
isPaid           // Si está pagado (computed)
totalPaid        // Total pagado (computed)</pre>

    <h3>Métodos</h3>
    <pre class="ux-code-block" data-lang="javascript">selectMethod(methodId)           // Seleccionar método
setAmount(amount)                // Establecer importe
addQuickAmount(amount)           // Añadir importe rápido
setExactAmount()                 // Establecer importe exacto
addSplitPayment(methodId, amount) // Añadir pago dividido
removeSplitPayment(paymentId)    // Eliminar pago dividido
processPayment()                 // Procesar pago
reset()                          // Reiniciar
formatCurrency(amount)           // Formatear moneda
getIcon(name)                    // Obtener icono SVG</pre>

    <h3>Iconos disponibles</h3>
    <pre class="ux-code-block" data-lang="text">cash, card, contactless, wallet, transfer, voucher, crypto, qr, check</pre>
  </section>

  <!-- HTMX + Django Integration -->
  <section class="demo-section">
    <h2>HTMX + Django</h2>
    <p style="color: var(--ux-text-secondary); margin-bottom: 1rem;">
      Integración con Django para procesamiento de pagos en tiempo real usando HTMX.
    </p>

    <h3>Formulario de Pago con HTMX</h3>
    <pre class="ux-code-block" data-lang="html">&lt;!-- Formulario que envía el pago al servidor --&gt;
&lt;form x-data="uxPayment({
  total: {{ order.total }},
  methods: [
    { id: 'cash', name: 'Efectivo', icon: 'cash' },
    { id: 'card', name: 'Tarjeta', icon: 'card' },
    { id: 'contactless', name: 'Contactless', icon: 'contactless' }
  ]
})"
  hx-post="{% url 'payments:process' order.id %}"
  hx-target="#payment-result"
  hx-swap="innerHTML"
  hx-indicator="#payment-spinner"&gt;

  {% csrf_token %}
  &lt;input type="hidden" name="method" x-model="selectedMethod"&gt;
  &lt;input type="hidden" name="amount_received" x-model="amountReceived"&gt;

  &lt;div class="ux-payment"&gt;
    &lt;div class="ux-payment-methods"&gt;
      &lt;template x-for="method in methods" :key="method.id"&gt;
        &lt;div class="ux-payment-method"
             :class="{ 'ux-payment-method--selected': selectedMethod === method.id }"
             @click="selectMethod(method.id)"&gt;
          &lt;div class="ux-payment-method__icon" x-html="getIcon(method.icon)"&gt;&lt;/div&gt;
          &lt;span class="ux-payment-method__name" x-text="method.name"&gt;&lt;/span&gt;
        &lt;/div&gt;
      &lt;/template&gt;
    &lt;/div&gt;

    &lt;button type="submit"
            class="ux-button ux-color-success"
            style="width: 100%;"
            :disabled="!selectedMethod || (selectedMethod === 'cash' && !isPaid)"&gt;
      &lt;span class="ux-spinner ux-spinner--sm" id="payment-spinner"&gt;&lt;/span&gt;
      Procesar Pago
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/form&gt;

&lt;div id="payment-result"&gt;&lt;/div&gt;</pre>

    <h3>Vista Django para procesar pagos</h3>
    <pre class="ux-code-block" data-lang="python"># views.py
from django.http import HttpResponse
from django.views.decorators.http import require_POST
from django.template.loader import render_to_string
from decimal import Decimal

@require_POST
def process_payment(request, order_id):
    order = get_object_or_404(Order, id=order_id)

    method = request.POST.get('method')
    amount_received = Decimal(request.POST.get('amount_received', '0'))

    # Validar el pago
    if method == 'cash' and amount_received < order.total:
        return HttpResponse(
            render_to_string('payments/_error.html', {
                'message': f'Importe insuficiente. Faltan {order.total - amount_received}€'
            })
        )

    # Crear el registro de pago
    payment = Payment.objects.create(
        order=order,
        method=method,
        amount=order.total,
        amount_received=amount_received if method == 'cash' else order.total,
        change=max(Decimal('0'), amount_received - order.total) if method == 'cash' else Decimal('0')
    )

    # Marcar orden como pagada
    order.status = 'paid'
    order.save()

    # Retornar fragmento de éxito
    return HttpResponse(
        render_to_string('payments/_success.html', {
            'payment': payment,
            'order': order
        })
    )</pre>

    <h3>Modelo de Pago</h3>
    <pre class="ux-code-block" data-lang="python"># models.py
from django.db import models

class Payment(models.Model):
    PAYMENT_METHODS = [
        ('cash', 'Efectivo'),
        ('card', 'Tarjeta'),
        ('contactless', 'Contactless'),
        ('transfer', 'Transferencia'),
    ]

    order = models.ForeignKey('Order', on_delete=models.CASCADE, related_name='payments')
    method = models.CharField(max_length=20, choices=PAYMENT_METHODS)
    amount = models.DecimalField(max_digits=10, decimal_places=2)
    amount_received = models.DecimalField(max_digits=10, decimal_places=2)
    change = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    created_at = models.DateTimeField(auto_now_add=True)

    @property
    def is_split(self):
        return self.order.payments.count() > 1</pre>

    <h3>Pago dividido con HTMX</h3>
    <pre class="ux-code-block" data-lang="html">&lt;!-- Pago dividido que añade pagos parciales --&gt;
&lt;div x-data="uxPayment({
  total: {{ order.total }},
  allowSplit: true,
  methods: [
    { id: 'cash', name: 'Efectivo', icon: 'cash' },
    { id: 'card', name: 'Tarjeta', icon: 'card' },
    { id: 'voucher', name: 'Vale', icon: 'voucher' }
  ]
})"&gt;
  &lt;div class="ux-payment"&gt;
    &lt;!-- Lista de pagos parciales realizados --&gt;
    &lt;div id="partial-payments" hx-get="{% url 'payments:partials' order.id %}" hx-trigger="load"&gt;
      &lt;!-- Se carga dinámicamente --&gt;
    &lt;/div&gt;

    &lt;!-- Formulario para añadir pago parcial --&gt;
    &lt;form hx-post="{% url 'payments:add_partial' order.id %}"
          hx-target="#partial-payments"
          hx-swap="innerHTML"
          @htmx:after-request="if(event.detail.successful) { amountReceived = 0; selectedMethod = null; }"&gt;
      {% csrf_token %}
      &lt;input type="hidden" name="method" x-model="selectedMethod"&gt;
      &lt;input type="hidden" name="amount" x-model="amountReceived"&gt;

      &lt;div class="ux-payment-methods ux-payment-methods--3col"&gt;
        &lt;template x-for="method in methods" :key="method.id"&gt;
          &lt;div class="ux-payment-method"
               :class="{ 'ux-payment-method--selected': selectedMethod === method.id }"
               @click="selectMethod(method.id)"&gt;
            &lt;div class="ux-payment-method__icon" x-html="getIcon(method.icon)"&gt;&lt;/div&gt;
            &lt;span class="ux-payment-method__name" x-text="method.name"&gt;&lt;/span&gt;
          &lt;/div&gt;
        &lt;/template&gt;
      &lt;/div&gt;

      &lt;div class="ux-input" style="margin: 1rem 0;"&gt;
        &lt;input type="number" step="0.01" name="amount_input"
               x-model="amountReceived" :max="amountDue"
               placeholder="0.00"&gt;
        &lt;label&gt;Importe&lt;/label&gt;
      &lt;/div&gt;

      &lt;button type="submit" class="ux-button ux-color-primary" style="width: 100%;"
              :disabled="!selectedMethod || amountReceived <= 0"&gt;
        Añadir Pago
      &lt;/button&gt;
    &lt;/form&gt;
  &lt;/div&gt;
&lt;/div&gt;</pre>

    <h3>Vista para pagos parciales</h3>
    <pre class="ux-code-block" data-lang="python"># views.py
@require_POST
def add_partial_payment(request, order_id):
    order = get_object_or_404(Order, id=order_id)

    method = request.POST.get('method')
    amount = Decimal(request.POST.get('amount', '0'))

    # Calcular cuánto queda por pagar
    total_paid = sum(p.amount for p in order.payments.all())
    remaining = order.total - total_paid

    if amount > remaining:
        amount = remaining

    # Crear pago parcial
    Payment.objects.create(
        order=order,
        method=method,
        amount=amount,
        amount_received=amount,
        change=Decimal('0')
    )

    # Verificar si el pedido está completamente pagado
    new_total_paid = sum(p.amount for p in order.payments.all())
    if new_total_paid >= order.total:
        order.status = 'paid'
        order.save()

    return HttpResponse(
        render_to_string('payments/_partials_list.html', {
            'order': order,
            'payments': order.payments.all(),
            'remaining': order.total - new_total_paid
        })
    )

def get_partial_payments(request, order_id):
    order = get_object_or_404(Order, id=order_id)
    total_paid = sum(p.amount for p in order.payments.all())

    return HttpResponse(
        render_to_string('payments/_partials_list.html', {
            'order': order,
            'payments': order.payments.all(),
            'remaining': order.total - total_paid
        })
    )</pre>

    <h3>Template para lista de pagos parciales</h3>
    <pre class="ux-code-block" data-lang="html">&lt;!-- templates/payments/_partials_list.html --&gt;
{% if payments %}
&lt;div class="ux-payment-split"&gt;
  {% for payment in payments %}
  &lt;div class="ux-payment-split__item"&gt;
    &lt;div class="ux-payment-split__method"&gt;
      &lt;span class="ux-payment-split__method-name"&gt;{{ payment.get_method_display }}&lt;/span&gt;
    &lt;/div&gt;
    &lt;span class="ux-payment-split__amount"&gt;{{ payment.amount }}€&lt;/span&gt;
    &lt;button class="ux-payment-split__remove"
            hx-delete="{% url 'payments:remove_partial' payment.id %}"
            hx-target="#partial-payments"
            hx-swap="innerHTML"
            hx-confirm="¿Eliminar este pago?"&gt;
      &amp;times;
    &lt;/button&gt;
  &lt;/div&gt;
  {% endfor %}
&lt;/div&gt;

&lt;div class="ux-payment-summary"&gt;
  &lt;div class="ux-payment-summary__row"&gt;
    &lt;span class="ux-payment-summary__label"&gt;Total&lt;/span&gt;
    &lt;span class="ux-payment-summary__value"&gt;{{ order.total }}€&lt;/span&gt;
  &lt;/div&gt;
  &lt;div class="ux-payment-summary__row"&gt;
    &lt;span class="ux-payment-summary__label"&gt;Pagado&lt;/span&gt;
    &lt;span class="ux-payment-summary__value"&gt;{{ payments|sum:'amount' }}€&lt;/span&gt;
  &lt;/div&gt;
  {% if remaining > 0 %}
  &lt;div class="ux-payment-summary__row"&gt;
    &lt;span class="ux-payment-summary__label"&gt;Pendiente&lt;/span&gt;
    &lt;span class="ux-payment-summary__value" style="color: var(--ux-danger);"&gt;{{ remaining }}€&lt;/span&gt;
  &lt;/div&gt;
  {% endif %}
&lt;/div&gt;

{% if remaining <= 0 %}
&lt;div class="ux-alert ux-color-success--soft" style="margin-top: 1rem;"&gt;
  Pago completado
&lt;/div&gt;
{% endif %}
{% endif %}</pre>

    <h3>URLs de Django</h3>
    <pre class="ux-code-block" data-lang="python"># urls.py
from django.urls import path
from . import views

app_name = 'payments'

urlpatterns = [
    path('&lt;int:order_id&gt;/process/', views.process_payment, name='process'),
    path('&lt;int:order_id&gt;/partials/', views.get_partial_payments, name='partials'),
    path('&lt;int:order_id&gt;/partials/add/', views.add_partial_payment, name='add_partial'),
    path('partial/&lt;int:payment_id&gt;/remove/', views.remove_partial_payment, name='remove_partial'),
]</pre>

    <h3>Integración con pasarela de pago</h3>
    <pre class="ux-code-block" data-lang="python"># views.py - Ejemplo con Stripe
import stripe
from django.conf import settings

stripe.api_key = settings.STRIPE_SECRET_KEY

@require_POST
def process_card_payment(request, order_id):
    order = get_object_or_404(Order, id=order_id)

    try:
        # Crear PaymentIntent de Stripe
        intent = stripe.PaymentIntent.create(
            amount=int(order.total * 100),  # Stripe usa centavos
            currency='eur',
            metadata={'order_id': order.id}
        )

        return HttpResponse(
            render_to_string('payments/_stripe_form.html', {
                'client_secret': intent.client_secret,
                'order': order
            })
        )
    except stripe.error.StripeError as e:
        return HttpResponse(
            render_to_string('payments/_error.html', {
                'message': str(e)
            }),
            status=400
        )

# Webhook para confirmar pago
@csrf_exempt
def stripe_webhook(request):
    payload = request.body
    sig_header = request.META.get('HTTP_STRIPE_SIGNATURE')

    try:
        event = stripe.Webhook.construct_event(
            payload, sig_header, settings.STRIPE_WEBHOOK_SECRET
        )
    except ValueError:
        return HttpResponse(status=400)
    except stripe.error.SignatureVerificationError:
        return HttpResponse(status=400)

    if event['type'] == 'payment_intent.succeeded':
        intent = event['data']['object']
        order_id = intent['metadata']['order_id']

        order = Order.objects.get(id=order_id)
        Payment.objects.create(
            order=order,
            method='card',
            amount=Decimal(intent['amount']) / 100,
            amount_received=Decimal(intent['amount']) / 100,
            stripe_payment_intent=intent['id']
        )
        order.status = 'paid'
        order.save()

    return HttpResponse(status=200)</pre>
  </section>

</body>
</html>
