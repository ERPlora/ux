# views.py
from django.shortcuts import render
from django.http import HttpResponse
from django.template.loader import render_to_string
from django.utils import timezone
from datetime import timedelta
from .models import ActivityLog

def activity_timeline(request):
    """Vista principal del timeline de actividad."""
    activities = ActivityLog.objects.select_related('user')[:20]

    # Agrupar por fecha
    grouped = {}
    today = timezone.now().date()
    yesterday = today - timedelta(days=1)

    for activity in activities:
        date = activity.created_at.date()
        if date == today:
            key = 'Hoy'
        elif date == yesterday:
            key = 'Ayer'
        else:
            key = date.strftime('%d %b %Y')

        if key not in grouped:
            grouped[key] = []
        grouped[key].append(activity)

    return render(request, 'activity/timeline.html', {
        'grouped_activities': grouped,
    })

def activity_timeline_partial(request):
    """Partial para cargar mas actividades via HTMX."""
    offset = int(request.GET.get('offset', 0))
    limit = int(request.GET.get('limit', 10))

    activities = ActivityLog.objects.select_related('user')[offset:offset+limit]

    html = render_to_string('activity/_timeline_items.html', {
        'activities': activities,
    }, request=request)

    return HttpResponse(html)

def activity_stream(request):
    """SSE endpoint para actualizaciones en tiempo real."""
    from django.http import StreamingHttpResponse
    import json

    def event_stream():
        last_id = ActivityLog.objects.first().id if ActivityLog.objects.exists() else 0

        while True:
            new_activities = ActivityLog.objects.filter(id__gt=last_id)
            for activity in new_activities:
                html = render_to_string('activity/_timeline_item.html', {
                    'activity': activity
                })
                yield f"data: {json.dumps({'html': html})}\n\n"
                last_id = activity.id

            import time
            time.sleep(2)

    response = StreamingHttpResponse(
        event_stream(),
        content_type='text/event-stream'
    )
    response['Cache-Control'] = 'no-cache'
    return response
