# views.py
from django.shortcuts import render
from django.http import HttpResponse
from .models import Product

def product_list(request):
    """
    Vista que filtra productos por rango de precio.
    Soporta peticiones HTMX para actualizacion parcial.
    """
    products = Product.objects.filter(is_active=True)

    # Filtrar por categoria
    category = request.GET.get('category')
    if category:
        products = products.filter(category__slug=category)

    # Filtrar por rango de precio
    price_min = request.GET.get('price_min')
    price_max = request.GET.get('price_max')

    if price_min:
        products = products.filter(price__gte=float(price_min))
    if price_max:
        products = products.filter(price__lte=float(price_max))

    # Ordenamiento
    sort = request.GET.get('sort', 'name')
    sort_options = {
        'price_asc': 'price',
        'price_desc': '-price',
        'name': 'name',
        'newest': '-created_at',
    }
    products = products.order_by(sort_options.get(sort, 'name'))

    context = {
        'products': products,
        'price_min': price_min or 0,
        'price_max': price_max or 1000,
        'total_count': products.count(),
    }

    # Si es peticion HTMX, devolver solo el partial
    if request.headers.get('HX-Request'):
        return render(request, 'products/partials/product_list.html', context)

    return render(request, 'products/list.html', context)
