# views.py
from django.http import HttpResponse
from django.views.decorators.http import require_POST
from django.core.exceptions import ValidationError
import os

# Configuracion
ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'application/pdf']
MAX_FILE_SIZE = 10 * 1024 * 1024  # 10MB

def validate_file(file):
    """Valida tipo y tamano del archivo."""
    # Validar tipo MIME
    if file.content_type not in ALLOWED_TYPES:
        raise ValidationError(f'Tipo no permitido: {file.content_type}')

    # Validar tamano
    if file.size > MAX_FILE_SIZE:
        size_mb = file.size / (1024 * 1024)
        raise ValidationError(f'Archivo muy grande: {size_mb:.1f}MB (max 10MB)')

    # Validar extension
    ext = os.path.splitext(file.name)[1].lower()
    allowed_exts = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.pdf']
    if ext not in allowed_exts:
        raise ValidationError(f'Extension no permitida: {ext}')

    return True

@require_POST
def upload_file(request):
    """Procesa upload de archivo."""
    file = request.FILES.get('file')

    if not file:
        return HttpResponse('''
            <div class="ux-alert ux-color-danger">
                <strong>Error:</strong> No se recibio ningun archivo
            </div>
        ''', status=400)

    try:
        validate_file(file)

        # Guardar archivo (ejemplo simple)
        from django.core.files.storage import default_storage
        path = default_storage.save(f'uploads/{file.name}', file)

        return HttpResponse(f'''
            <div class="ux-alert ux-color-success">
                <strong>Exito!</strong> Archivo subido: {file.name}
                <p style="margin-top: 0.5rem; font-size: 0.875rem;">
                    Tamano: {file.size / 1024:.1f} KB
                </p>
            </div>
        ''')

    except ValidationError as e:
        return HttpResponse(f'''
            <div class="ux-alert ux-color-danger">
                <strong>Error:</strong> {e.message}
            </div>
        ''', status=400)

    except Exception as e:
        return HttpResponse(f'''
            <div class="ux-alert ux-color-danger">
                <strong>Error:</strong> Error al procesar archivo
            </div>
        ''', status=500)
