# views.py
from django.shortcuts import render, redirect
from django.contrib.auth import login
from django.views.decorators.http import require_POST
from django.http import HttpResponse
from .models import OTPToken
from .forms import OTPVerifyForm
import pyotp

def otp_verify(request):
    """Verificar codigo OTP enviado por SMS/Email"""
    if request.method == 'POST':
        form = OTPVerifyForm(request.POST)

        if form.is_valid():
            otp_code = form.cleaned_data['otp_code']
            user_id = request.session.get('pending_user_id')

            try:
                otp_token = OTPToken.objects.get(
                    user_id=user_id,
                    is_used=False
                )

                # Verificar codigo con pyotp
                totp = pyotp.TOTP(otp_token.secret, interval=300)

                if totp.verify(otp_code):
                    otp_token.is_used = True
                    otp_token.save()

                    # Login del usuario
                    login(request, otp_token.user)

                    # Respuesta de exito con HTMX
                    if request.headers.get('HX-Request'):
                        return render(request, 'auth/otp_success.html')
                    return redirect('dashboard')
                else:
                    form.add_error('otp_code', 'Codigo incorrecto o expirado')

            except OTPToken.DoesNotExist:
                form.add_error('otp_code', 'Codigo no valido')

        # Re-renderizar con errores
        return render(request, 'auth/otp_verify.html', {'form': form})

    return render(request, 'auth/otp_verify.html', {
        'form': OTPVerifyForm()
    })


@require_POST
def otp_resend(request):
    """Reenviar codigo OTP"""
    user_id = request.session.get('pending_user_id')

    if user_id:
        # Invalidar tokens anteriores
        OTPToken.objects.filter(
            user_id=user_id,
            is_used=False
        ).update(is_used=True)

        # Generar nuevo token
        otp_token = OTPToken.create_for_user(user_id)

        # Enviar SMS/Email (usar Celery para async)
        send_otp_notification.delay(user_id, otp_token.get_code())

        if request.headers.get('HX-Request'):
            response = HttpResponse(status=204)
            response['HX-Trigger'] = 'otp-resent'
            return response

    return redirect('otp_verify')
