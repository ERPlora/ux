# views.py
import phonenumbers
from django.http import HttpResponse
from django.views.decorators.http import require_POST

@require_POST
def validate_phone(request):
    """Valida el numero de telefono usando phonenumbers."""
    phone_number = request.POST.get('phone_number', '').strip()
    country_code = request.POST.get('country_code', 'ES')
    dial_code = request.POST.get('dial_code', '+34')

    if not phone_number:
        return HttpResponse('''
            <span class="ux-phone-field__helper">
                Ingresa un numero de telefono
            </span>
        ''')

    try:
        # Parsear el numero con el codigo de pais
        parsed = phonenumbers.parse(phone_number, country_code)

        # Validar si es un numero posible y valido
        is_valid = phonenumbers.is_valid_number(parsed)
        is_possible = phonenumbers.is_possible_number(parsed)

        if is_valid:
            # Formatear el numero en formato internacional
            formatted = phonenumbers.format_number(
                parsed,
                phonenumbers.PhoneNumberFormat.INTERNATIONAL
            )
            # Obtener tipo de linea (movil, fijo, etc.)
            number_type = phonenumbers.number_type(parsed)
            type_names = {
                0: 'Fijo',
                1: 'Movil',
                2: 'Fijo o Movil',
                5: 'VoIP',
            }
            line_type = type_names.get(number_type, 'Desconocido')

            return HttpResponse(f'''
                <span class="ux-phone-field__helper is-valid" style="color: var(--ux-success);">
                    Numero valido: {formatted} ({line_type})
                </span>
            ''')
        elif is_possible:
            return HttpResponse('''
                <span class="ux-phone-field__helper" style="color: var(--ux-warning);">
                    Numero incompleto
                </span>
            ''')
        else:
            return HttpResponse('''
                <span class="ux-phone-field__helper is-invalid ux-phone-field__helper--error">
                    Numero no valido para este pais
                </span>
            ''')

    except phonenumbers.NumberParseException as e:
        return HttpResponse(f'''
            <span class="ux-phone-field__helper is-invalid ux-phone-field__helper--error">
                Error: {str(e)}
            </span>
        ''')
