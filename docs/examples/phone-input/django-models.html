# models.py
from django.db import models
from phonenumber_field.modelfields import PhoneNumberField

class Contact(models.Model):
    """Modelo con campo de telefono validado."""
    name = models.CharField(max_length=100)

    # Usando django-phonenumber-field
    phone = PhoneNumberField(
        region='ES',
        blank=True,
        help_text='Numero de telefono con codigo de pais'
    )

    # O almacenar componentes por separado
    phone_number = models.CharField(max_length=20, blank=True)
    country_code = models.CharField(max_length=3, default='ES')
    dial_code = models.CharField(max_length=5, default='+34')

    @property
    def full_phone(self):
        """Retorna el numero completo con codigo."""
        if self.phone_number:
            return f"{self.dial_code}{self.phone_number}"
        return str(self.phone) if self.phone else ''

    def clean(self):
        """Validacion adicional del telefono."""
        import phonenumbers
        if self.phone_number:
            try:
                parsed = phonenumbers.parse(
                    self.phone_number,
                    self.country_code
                )
                if not phonenumbers.is_valid_number(parsed):
                    from django.core.exceptions import ValidationError
                    raise ValidationError({
                        'phone_number': 'Numero de telefono no valido'
                    })
            except phonenumbers.NumberParseException:
                from django.core.exceptions import ValidationError
                raise ValidationError({
                    'phone_number': 'Formato de telefono incorrecto'
                })
